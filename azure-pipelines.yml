# vim: se expandtab ts=4 sw=2 ai

trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  buildPlatform: x64
  buildConfiguration: 'Release'

steps:
  - script: |
      for /f "usebackq tokens=*" %%l in (`"c:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -property installationPath`) do set bar=%%l
      call "%bar%"\Common7\Tools\VsDevCmd.bat -arch=$(BuildPlatform)
      copy config\win32 config.h
      nmake -f win32\makefile.win32 
      for /f "usebackq tokens=3" %%i in (`findstr REV patchlevel.h`) do set TCSH_REV=%%i
      for /f "usebackq tokens=3" %%j in (`findstr VERS patchlevel.h`) do set TCSH_VERS=%%j
      for /f "usebackq tokens=3" %%k in (`findstr PATCHLEVEL patchlevel.h`) do set TCSH_PATCHLEVEL=%%k
      echo "##vso[task.setvariable variable=BuildTitle]%TCSH_REV%.%TCSH_VERS%.%TCSH_PATCHLEVEL%"
    displayName: Build

#  - task: PublishPipelineArtifact@1
#   inputs:
#     targetPath: '$(System.DefaultWorkingDirectory)/tcsh-x64.exe'
#      artifact: 'binary'
#      publishLocation: 'pipeline'
  - task: GitHubRelease@0
    inputs:
      gitHubConnection: github.com_amoldeshpande
      repositoryName: $(Build.Repository.Name) 
      tagSource: 'manual' 
      tag: $(Build.BuildNumber) 
      title: $(BuildTitle) 
      assets: '$(System.DefaultWorkingDirectory)/tcsh-x64.exe' 
